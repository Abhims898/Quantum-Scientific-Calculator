<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quantum Scientific Calculator ⚛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: radial-gradient(circle at top, #08142a, #030912);
      color: #eaf6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .calc {
      background: #0f1724;
      padding: 18px;
      border-radius: 14px;
      width: 360px;
      box-shadow: 0 10px 40px rgba(0, 255, 255, 0.2);
    }
    .display {
      background: #000;
      color: #00eaff;
      font-size: 20px;
      padding: 12px;
      border-radius: 8px;
      text-align: right;
      min-height: 42px;
      box-shadow: inset 0 0 8px #00ffff44;
    }
    .row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    button {
      width: 72px;
      height: 52px;
      border-radius: 8px;
      border: none;
      background: #152233;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: 0.15s;
    }
    button:hover { background: #233547; transform: scale(1.05); }
    button.op { background: #1e334e; }
    button.equal { background: #00d4ff; color: #002; font-weight: 700; }
    .small { width: 54px; height: 44px; font-size: 16px; }
    .controls { margin-top: 10px; display: flex; gap: 8px; }
    .exprbox {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      background: #071226;
      color: #eaf6ff;
      border: none;
      font-family: monospace;
    }
    .status {
      font-size: 12px;
      color: #9be7ff;
      text-align: center;
      margin-top: 8px;
    }

    /* --- Fixed scrollable history box --- */
    .history {
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
      font-family: monospace;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }
    .history::-webkit-scrollbar {
      width: 6px;
    }
    .history::-webkit-scrollbar-thumb {
      background: #00eaff55;
      border-radius: 4px;
    }
    .history::-webkit-scrollbar-thumb:hover {
      background: #00eaff99;
    }

    .mode-toggle {
      margin-top: 8px;
      text-align: center;
    }
    .mode-toggle label {
      font-size: 14px;
      color: #8de2ff;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="calc">
    <div id="display" class="display">0</div>

    <div class="row">
      <button onclick="clr()">C</button>
      <button onclick="back()">⌫</button>
      <button class="op" onclick="append('(')">(</button>
      <button class="op" onclick="append(')')">)</button>
    </div>

    <div class="row">
      <button onclick="append('7')">7</button>
      <button onclick="append('8')">8</button>
      <button onclick="append('9')">9</button>
      <button class="op" onclick="append('/')">÷</button>
    </div>

    <div class="row">
      <button onclick="append('4')">4</button>
      <button onclick="append('5')">5</button>
      <button onclick="append('6')">6</button>
      <button class="op" onclick="append('*')">×</button>
    </div>

    <div class="row">
      <button onclick="append('1')">1</button>
      <button onclick="append('2')">2</button>
      <button onclick="append('3')">3</button>
      <button class="op" onclick="append('-')">−</button>
    </div>

    <div class="row">
      <button onclick="append('0')">0</button>
      <button onclick="append('.')">.</button>
      <button onclick="append('+')">+</button>
      <button class="equal" onclick="equal()">=</button>
    </div>

    <div class="row">
      <button class="op small" onclick="append('sin(')">sin</button>
      <button class="op small" onclick="append('cos(')">cos</button>
      <button class="op small" onclick="append('tan(')">tan</button>
      <button class="op small" onclick="append('sqrt(')">√</button>
    </div>

    <div class="row">
      <button class="op small" onclick="append('log(')">log</button>
      <button class="op small" onclick="append('ln(')">ln</button>
      <button class="op small" onclick="append('exp(')">exp</button>
      <button class="op small" onclick="append('abs(')">abs</button>
    </div>

    <div class="controls">
      <input id="expr" class="exprbox" placeholder="Type: sin(pi/2), log(10), 3+4j" />
    </div>

    <div class="mode-toggle">
      <label><input type="radio" name="angleMode" value="deg" checked> Degrees</label>
      <label><input type="radio" name="angleMode" value="rad"> Radians</label>
    </div>

    <div style="display:flex; gap:6px; margin-top:8px;">
      <button onclick="insertExpr()">Use typed</button>
      <button onclick="calcFromExpr()" class="op">Calc typed</button>
      <button onclick="clearHistory()" class="small" style="background:#ff6b6b">Clear H</button>
    </div>

    <div class="status">
      Quantum Mode: <strong id="qflag">{{ 'Enabled ⚛' if quantum else 'Disabled' }}</strong>
    </div>

    <div class="history" id="history">
      <strong>History</strong>
      <div id="hist-list"></div>
    </div>
  </div>

<script>
const display = document.getElementById('display');

function append(s){ if(display.innerText === '0') display.innerText = s; else display.innerText += s; }
function clr(){ display.innerText = '0'; }
function back(){ display.innerText = display.innerText.slice(0,-1) || '0'; }

async function equal(){
  const expr = display.innerText;
  const angleMode = document.querySelector('input[name="angleMode"]:checked').value;
  const res = await fetch('/calculate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({expression: expr, mode: angleMode})
  });
  const j = await res.json();
  if(j.ok){ showResult(j.result); await refreshHistory(); } else { display.innerText = 'Error'; console.error(j); }
}

function showResult(r){
  if(typeof r === 'object' && r !== null && r.__complex__){
    const s = (Number(r.real).toFixed(6)) + (r.imag>=0?'+':'') + (Number(r.imag).toFixed(6)) + 'j';
    display.innerText = s;
  } else if(typeof r === 'object'){
    display.innerText = JSON.stringify(r);
  } else {
    display.innerText = String(r);
  }
}

function insertExpr(){
  const typed = document.getElementById('expr').value.trim();
  if(typed) display.innerText = typed;
}

async function calcFromExpr(){
  const typed = document.getElementById('expr').value.trim();
  const angleMode = document.querySelector('input[name="angleMode"]:checked').value;
  if(!typed) return;
  const res = await fetch('/calculate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({expression: typed, mode: angleMode})
  });
  const j = await res.json();
  if(j.ok){ showResult(j.result); await refreshHistory(); } else { display.innerText='Error'; console.error(j); }
}

async function refreshHistory(){
  const resp = await fetch('/history');
  const list = await resp.json();
  const container = document.getElementById('hist-list');
  container.innerHTML = '';
  for(const item of list.slice(0,20)){
    const el = document.createElement('div');
    el.innerText = `${item.expr}  =>  ${JSON.stringify(item.result)}`;
    container.appendChild(el);
  }
  // Auto-scroll to bottom
  const historyBox = document.getElementById('history');
  historyBox.scrollTop = historyBox.scrollHeight;
}

async function clearHistory(){
  await fetch('/clear_history', {method:'POST'});
  await refreshHistory();
  display.innerText='0';
}

refreshHistory();
</script>
</body>
</html>
